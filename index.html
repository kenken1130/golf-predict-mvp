<!-- 
================================================================================
ã‚´ãƒ«ãƒ•äºˆæƒ³SNS MVP (Finalized)
æ©Ÿèƒ½: åŒ¿åèªè¨¼, Firestoreãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–, ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆäºˆæƒ³, SNSæŠ•ç¨¿, 
      ã‚¹ãƒãƒ³ã‚µãƒ¼é€£æº(ã‚¿ã‚¹ã‚¯ã§ãƒã‚¤ãƒ³ãƒˆ2å€ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–), ãƒã‚¤ãƒ³ãƒˆäº¤æ›æ‰€, ç®¡ç†ãƒ“ãƒ¥ãƒ¼
================================================================================
-->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOLFIN äºˆæƒ³SNS MVP</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .container-mobile {
            max-width: 420px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-2">
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="app" class="container-mobile mx-auto min-h-screen bg-white shadow-lg rounded-lg overflow-hidden">
        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°/ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="loading-screen" class="flex flex-col items-center justify-center h-screen text-gray-500">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–ä¸­ã§ã™...</p>
        </div>
        <div id="error-message" class="hidden p-8 text-center bg-red-100 text-red-700">
            åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
        </div>
        
        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºã‚¨ãƒªã‚¢ (åˆæœŸåŒ–å¾Œã«ã“ã“ã«æç”»ã•ã‚Œã‚‹) -->
        <div id="content" class="hidden">
            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ (å¸¸ã«è¡¨ç¤º) -->
            <header class="sticky top-0 bg-white border-b border-gray-100 z-10 p-4 flex justify-between items-center">
                <h1 class="text-2xl font-extrabold text-indigo-600 cursor-pointer" onclick="window.navigate('home')">GOLFIN Predict</h1>
                <div class="flex space-x-3 items-center">
                    <button id="admin-view-btn" class="text-sm text-gray-500 hover:text-indigo-600" onclick="window.navigate('admin')">ç®¡ç†</button>
                    <button onclick="window.navigate('mypage')" class="p-2 rounded-full bg-indigo-50 hover:bg-indigo-100 transition">
                        <i data-lucide="user" class="h-6 w-6 text-indigo-600"></i>
                    </button>
                </div>
            </header>
            
            <!-- ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
            <div id="view-container" class="p-4 pb-20"></div>

            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒƒã‚¿ãƒ¼ -->
            <footer id="nav-footer" class="fixed bottom-0 left-0 right-0 z-20 bg-white border-t border-gray-100 shadow-md flex justify-around p-3 container-mobile mx-auto hidden">
                <button onclick="window.navigate('home')" class="nav-item">
                    <i data-lucide="home" class="h-6 w-6"></i>
                    <span class="text-xs">ãƒ›ãƒ¼ãƒ </span>
                </button>
                <button onclick="window.navigate('mypage')" class="nav-item">
                    <i data-lucide="award" class="h-6 w-6"></i>
                    <span class="text-xs">å®Ÿç¸¾</span>
                </button>
            </footer>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // =========================================================================
        // 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨åˆæœŸè¨­å®š
        // =========================================================================
        let app, db, auth, storage;
        let userId = 'default-user';
        let appId = 'default-app-id';

        // å¿…é ˆã®ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºä¿
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        appId = typeof __app_id !== 'undefined' ? __app_id : 'golfin-predict-mvp';

        // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã‚’å®šç¾© (ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿)
        const getCollectionPath = (collectionName) => {
            return `/artifacts/${appId}/public/data/${collectionName}`;
        };

        const tournamentsCol = getCollectionPath('tournaments');
        const profilesCol = getCollectionPath('profiles');
        const predictionsCol = getCollectionPath('predictions');
        const postsCol = getCollectionPath('posts');
        const userTasksCol = getCollectionPath('user_tasks');
        const rewardsCol = getCollectionPath('rewards');

        // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ (åˆæœŸçŠ¶æ…‹)
        let mockData = {
            tournaments: [
                { id: 't1', title: 'ç¬¬1å› GOLFINæ¯', sponsorName: 'GolfGear Pro', prizePool: 10000, course: 'å¯Œå£«ã‚«ãƒ³ãƒˆãƒªãƒ¼', date: '2025-12-01', status: 'voting', winnerId: null, 
                  taskType: 'quiz_answer', taskValue: 'ã“ã®ã‚¹ãƒãƒ³ã‚µãƒ¼ã®ãƒ­ã‚´ã‚«ãƒ©ãƒ¼ã¯ï¼Ÿ', taskAnswer: 'ã¿ã©ã‚Š', // æ­£è§£ã‚’ã€Œã¿ã©ã‚Šã€ã«è¨­å®š
                  players: [{ id: 'p1', name: 'ç”°ä¸­ å¤ªéƒ' }, { id: 'p2', name: 'ä½è—¤ èŠ±å­' }, { id: 'p3', name: 'å±±æœ¬ å¥å¤ª' }] 
                },
                { id: 't2', title: 'å†¬ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚³ãƒ³ãƒš', sponsorName: 'Travel Golf', prizePool: 5000, course: 'æ²–ç¸„ã‚ªãƒ¼ã‚·ãƒ£ãƒ³', date: '2025-12-15', status: 'upcoming', winnerId: null,
                  taskType: 'video_watch', taskValue: 'https://placehold.co/400x200/22C55E/white?text=Sponsor+Video', taskAnswer: null,
                  players: [{ id: 'p4', name: 'éˆ´æœ¨ ä¸€éƒ' }, { id: 'p5', name: 'é«˜æ©‹ å„ªå­' }] 
                },
            ],
            rewards: [
                { id: 'r1', name: 'Amazonã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰ (1,000å††)', cost: 500, imageUrl: 'https://placehold.co/100x100/FEF2F2/F87171?text=Amazon+Gift' },
                { id: 'r2', name: 'æœ€æ–°ã‚´ãƒ«ãƒ•ãƒœãƒ¼ãƒ« (1ãƒ€ãƒ¼ã‚¹)', cost: 1200, imageUrl: 'https://placehold.co/100x100/DBEAFE/3B82F6?text=Golf+Ball' },
                { id: 'r3', name: 'é™å®šã‚­ãƒ£ãƒƒãƒ—', cost: 800, imageUrl: 'https://placehold.co/100x100/F0F9FF/0EA5E9?text=Cap' },
            ]
        };

        // =========================================================================
        // 2. èªè¨¼ãƒ»åˆæœŸåŒ–
        // =========================================================================

        window.onload = async () => {
            const loadingScreen = document.getElementById('loading-screen');
            const errorMessage = document.getElementById('error-message');
            const content = document.getElementById('content');
            
            try {
                if (!firebaseConfig) {
                    throw new Error("Firebase config is missing. Cannot initialize.");
                }

                // 1. FirebaseåˆæœŸåŒ–
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                
                // 2. èªè¨¼å‡¦ç†
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. èªè¨¼çŠ¶æ…‹ã®ç¢ºèªã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼IDè¨­å®š
                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                // 4. ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ– (åˆå›èµ·å‹•æ™‚ã®ã¿)
                await initializeMockData();

                // 5. UIã®è¡¨ç¤º
                loadingScreen.classList.add('hidden');
                content.classList.remove('hidden');
                document.getElementById('nav-footer').classList.remove('hidden');
                
                // åˆå›æç”»
                window.navigate('home'); // window.ã‚’ä»˜ã‘ã¦å‘¼ã³å‡ºã™
                
            } catch (error) {
                console.error("Initialization Error:", error);
                loadingScreen.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                errorMessage.textContent = `ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            }
        };

        // åˆå›èµ·å‹•æ™‚ã«ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«æ›¸ãè¾¼ã‚€é–¢æ•°
        async function initializeMockData() {
            try {
                // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
                const firstTournamentDoc = doc(db, tournamentsCol, mockData.tournaments[0].id);
                const docSnap = await getDoc(firstTournamentDoc);

                if (!docSnap.exists()) {
                    console.log("Mock data not found. Initializing data...");

                    // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã€ãƒªãƒ¯ãƒ¼ãƒ‰ã‚’æ›¸ãè¾¼ã¿
                    for (const t of mockData.tournaments) {
                        const players = t.players;
                        delete t.players; // playersé…åˆ—ã¯ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã—ãªã„ãŸã‚å‰Šé™¤
                        await setDoc(doc(db, tournamentsCol, t.id), t);
                        
                        // é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«æ›¸ãè¾¼ã‚€ (ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«é…åˆ—ã‚’ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦ä¿æŒ)
                        await setDoc(doc(db, tournamentsCol, t.id), { players: players }, { merge: true });
                    }
                    for (const r of mockData.rewards) {
                         await setDoc(doc(db, rewardsCol, r.id), r);
                    }
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åˆæœŸåŒ–
                    await setDoc(doc(db, profilesCol, userId), { 
                        name: 'åŒ¿åã‚´ãƒ«ãƒ•ã‚¡ãƒ¼', 
                        totalPoints: 500, // åˆæœŸãƒã‚¤ãƒ³ãƒˆ
                        bio: 'ã‚´ãƒ«ãƒ•äºˆæƒ³å§‹ã‚ã¾ã—ãŸï¼',
                        id: userId 
                    }, { merge: true });
                }
            } catch (e) {
                console.error("Error initializing mock data:", e);
                // åˆæœŸåŒ–å¤±æ•—ã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã¯ç¶™ç¶šã•ã›ã‚‹
            }
        }
        
        // =========================================================================
        // 3. ãƒ‡ãƒ¼ã‚¿æ“ä½œé–¢æ•° (Firestore CRUD)
        // =========================================================================

        /** ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾— */
        const getProfile = async (id) => {
            const docSnap = await getDoc(doc(db, profilesCol, id));
            return docSnap.exists() ? docSnap.data() : null;
        };

        /** ã‚¿ã‚¹ã‚¯å®Œäº†ãƒ•ãƒ©ã‚°ã‚’å–å¾— */
        const getTaskCompletion = async (tournamentId) => {
            const taskDoc = await getDoc(doc(db, userTasksCol, `${userId}_${tournamentId}`));
            return taskDoc.exists() ? taskDoc.data().completed : false;
        };
        
        /** ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†çŠ¶æ…‹ã«è¨­å®š */
        const completeTask = async (tournamentId) => {
            await setDoc(doc(db, userTasksCol, `${userId}_${tournamentId}`), {
                userId: userId,
                tournamentId: tournamentId,
                completed: true,
                completedAt: Timestamp.now()
            });
        };
        
        /** äºˆæƒ³ã¨æŠ•ç¨¿ã‚’Firestoreã«ä¿å­˜ */
        const submitPrediction = async (tournamentId, predictedPlayerId, comment, imageUrl = null) => {
            // äºˆæƒ³ (predictions) ã‚’ä¿å­˜
            await setDoc(doc(db, predictionsCol, `${userId}_${tournamentId}`), {
                tournamentId,
                userId,
                predictedPlayerId,
                isCorrect: null,
                pointsAwarded: 0,
                createdAt: Timestamp.now(),
            });

            // SNSæŠ•ç¨¿ (posts) ã‚’ä¿å­˜
            const newPostRef = doc(collection(db, postsCol));
            await setDoc(newPostRef, {
                id: newPostRef.id,
                userId: userId,
                tournamentId: tournamentId,
                type: 'prediction',
                text: comment,
                imageUrl: imageUrl,
                createdAt: Timestamp.now(),
                likes: 0,
            });
            return true;
        };

        /** ãƒªãƒ¯ãƒ¼ãƒ‰ã®äº¤æ›å‡¦ç† (ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³) */
        const handleExchangeReward = async (rewardId, cost) => {
            const profileRef = doc(db, profilesCol, userId);

            try {
                await runTransaction(db, async (transaction) => {
                    const profileDoc = await transaction.get(profileRef);

                    if (!profileDoc.exists()) {
                        throw new Error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                    }
                    
                    const currentPoints = profileDoc.data().totalPoints || 0;
                    if (currentPoints < cost) {
                        throw new Error(`ãƒã‚¤ãƒ³ãƒˆä¸è¶³ã§ã™ã€‚${cost}ptå¿…è¦ã§ã™ã€‚`);
                    }

                    // ãƒã‚¤ãƒ³ãƒˆã‚’æ¶ˆè²»ã—ã€ãƒªãƒ¯ãƒ¼ãƒ‰äº¤æ›å±¥æ­´ã‚’è¨˜éŒ² (MVPã§ã¯å±¥æ­´è¨˜éŒ²ã¯çœç•¥)
                    const newPoints = currentPoints - cost;
                    transaction.update(profileRef, { totalPoints: newPoints });

                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    return `äº¤æ›æˆåŠŸï¼${cost}ptã‚’æ¶ˆè²»ã—ã€${rewardId}ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`;
                });
                return { success: true, message: 'ãƒªãƒ¯ãƒ¼ãƒ‰äº¤æ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼' };
            } catch (e) {
                console.error("Exchange Transaction Failed:", e);
                return { success: false, message: e.message || 'äº¤æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' };
            }
        };


        // =========================================================================
        // 4. UIãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        // =========================================================================

        let currentView = 'home';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã« window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¨­å®š
        window.navigate = function(viewName, params = {}) {
            currentView = viewName;
            const viewContainer = document.getElementById('view-container');
            viewContainer.innerHTML = '';
            
            switch (viewName) {
                case 'home':
                    renderHomePage(viewContainer);
                    break;
                case 'tournament':
                    renderTournamentPage(viewContainer, params.id);
                    break;
                case 'sponsor':
                    renderSponsorPage(viewContainer, params.id);
                    break;
                case 'mypage':
                    renderMyPage(viewContainer);
                    break;
                case 'admin':
                    renderAdminPage(viewContainer);
                    break;
                case 'userprofile':
                    renderUserProfilePage(viewContainer, params.id);
                    break;
                case 'store':
                    renderRewardStore(viewContainer);
                    break;
                default:
                    renderHomePage(viewContainer);
            }
            // Lucideã‚¢ã‚¤ã‚³ãƒ³ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            lucide.createIcons();
            window.scrollTo(0, 0); // ç”»é¢ãƒˆãƒƒãƒ—ã¸ç§»å‹•
        }

        // =========================================================================
        // 5. å„ãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
        // =========================================================================

        /** ãƒ›ãƒ¼ãƒ ç”»é¢ (ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆä¸€è¦§) */
        function renderHomePage(container) {
            container.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">é–‹å‚¬ä¸­ã®äºˆæƒ³ã‚³ãƒ³ãƒš</h2>
                <p class="text-gray-600 mb-6">å‚åŠ ã‚¿ã‚¹ã‚¯ã¯ä»»æ„ã§ã™ã€‚ã‚¿ã‚¹ã‚¯å®Œäº†ã§çš„ä¸­ãƒã‚¤ãƒ³ãƒˆ2å€ã®ãƒãƒ£ãƒ³ã‚¹ï¼</p>
                <div id="tournament-list" class="space-y-4">
                    <p class="text-center text-gray-500">ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
                </div>
            `;

            onSnapshot(collection(db, tournamentsCol), (snapshot) => {
                const tournaments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const listHtml = tournaments.map(t => `
                    <div class="bg-white p-4 border border-indigo-100 rounded-xl shadow-md flex justify-between items-center transition hover:shadow-lg">
                        <div>
                            <p class="text-xl font-bold text-indigo-700">${t.title}</p>
                            <p class="text-sm text-gray-500">${t.sponsorName} / ğŸ† ${t.prizePool?.toLocaleString() || '---'}pt</p>
                            <span class="inline-block mt-1 px-3 py-1 text-xs font-semibold rounded-full ${t.status === 'voting' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${t.status === 'voting' ? 'æŠ•ç¥¨å—ä»˜ä¸­' : 'é–‹å‚¬äºˆå®š'}
                            </span>
                        </div>
                        <button onclick="window.navigate('tournament', { id: '${t.id}' })" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition">
                            äºˆæƒ³ã™ã‚‹
                        </button>
                    </div>
                `).join('');
                document.getElementById('tournament-list').innerHTML = listHtml || '<p class="text-center text-gray-500 p-8">ç¾åœ¨é–‹å‚¬ä¸­ã®ã‚³ãƒ³ãƒšã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                lucide.createIcons();
            });
        }
        
        /** ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè©³ç´°ç”»é¢ (æŠ•ç¥¨ã¨ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³) */
        async function renderTournamentPage(container, tournamentId) {
            container.innerHTML = '<p class="text-center text-gray-500">ãƒ­ãƒ¼ãƒ‰ä¸­...</p>';
            
            const tournamentDoc = await getDoc(doc(db, tournamentsCol, tournamentId));
            if (!tournamentDoc.exists()) {
                container.innerHTML = '<p class="text-red-500">ã“ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }
            const t = tournamentDoc.data();
            const isTaskCompleted = await getTaskCompletion(tournamentId);

            container.innerHTML = `
                <div class="space-y-6">
                    <!-- å¤§ä¼šæƒ…å ± -->
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-200">
                        <h2 class="text-3xl font-extrabold text-indigo-800 mb-2">${t.title}</h2>
                        <p class="text-md text-indigo-600 mb-1">ä¸»å‚¬: ${t.sponsorName}</p>
                        <p class="text-sm text-gray-600">ã‚³ãƒ¼ã‚¹: ${t.course} / é–‹å‚¬æ—¥: ${t.date}</p>
                        <p class="text-sm font-bold text-green-700 mt-2">ğŸ† è³é‡‘ç·é¡: ${t.prizePool?.toLocaleString()}pt</p>
                    </div>

                    <!-- äºˆæƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div id="prediction-section" class="bg-white p-5 rounded-xl shadow-lg border">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ¯ å„ªå‹äºˆæƒ³ (å˜å‹)</h3>
                        <div id="task-incentive-status"></div>
                        <form id="prediction-form" class="space-y-4"></form>
                    </div>

                    <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
                    <h3 class="text-2xl font-bold pt-4 border-t-2 mt-8 text-gray-800">ğŸ’¬ å¤§ä¼šã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h3>
                    <div id="timeline" class="space-y-4"></div>
                </div>
            `;
            
            // äºˆæƒ³æ¨©ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–è¡¨ç¤º
            const taskIncentiveStatus = document.getElementById('task-incentive-status');
            if (t.taskType && t.status === 'voting') {
                if (!isTaskCompleted) {
                    taskIncentiveStatus.innerHTML = `
                        <div class="bg-yellow-100 p-3 mb-4 rounded-lg border border-yellow-300">
                            <p class="font-semibold text-yellow-800 mb-2 flex items-center">
                                <i data-lucide="zap" class="w-5 h-5 mr-2"></i> ã‚¿ã‚¹ã‚¯å®Œäº†ã§çš„ä¸­ãƒã‚¤ãƒ³ãƒˆ<span class="text-red-600 text-lg font-extrabold mx-1">2å€</span>ï¼
                            </p>
                            <button onclick="window.navigate('sponsor', { id: '${tournamentId}' })" class="text-sm text-indigo-600 font-bold hover:underline">
                                ã‚¹ãƒãƒ³ã‚µãƒ¼ã®ã‚¿ã‚¹ã‚¯ã‚’ç¢ºèªã™ã‚‹ â†’
                            </button>
                        </div>
                    `;
                } else {
                    taskIncentiveStatus.innerHTML = `
                        <div class="bg-green-100 p-3 mb-4 rounded-lg border border-green-300">
                            <p class="font-semibold text-green-800 flex items-center">
                                <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> ã‚¿ã‚¹ã‚¯å®Œäº†æ¸ˆã¿ï¼çš„ä¸­æ™‚ã¯ãƒã‚¤ãƒ³ãƒˆ2å€ã§ã™ï¼
                            </p>
                        </div>
                    `;
                }
            }


            // äºˆæƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            const form = document.getElementById('prediction-form');
            form.innerHTML = `
                ${t.players.map(p => `
                    <label class="flex items-center p-3 bg-gray-50 rounded-lg border cursor-pointer hover:bg-indigo-50 transition">
                        <input type="radio" name="predictedPlayer" value="${p.id}" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 mr-3">
                        <span class="font-medium text-gray-700">${p.name}</span>
                    </label>
                `).join('')}
                
                <textarea id="comment-input" rows="2" placeholder="äºˆæƒ³ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ·»ãˆã¦SNSæŠ•ç¨¿ï¼ˆä»»æ„ï¼‰" class="w-full p-3 border rounded-lg focus:ring-indigo-500"></textarea>
                
                <div class="flex items-center space-x-2">
                    <input type="file" id="photo-upload" accept="image/*" class="hidden">
                    <button type="button" onclick="document.getElementById('photo-upload').click()" class="flex-shrink-0 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition">
                        <i data-lucide="camera" class="w-5 h-5 mr-1 inline-block"></i> å†™çœŸã‚’è¿½åŠ 
                    </button>
                    <button type="submit" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition disabled:bg-gray-400" ${t.status !== 'voting' ? 'disabled' : ''}>
                        ${t.status === 'voting' ? 'äºˆæƒ³ã‚’ç¢ºå®š & æŠ•ç¨¿ã™ã‚‹' : 'æŠ•ç¥¨ç· åˆ‡'}
                    </button>
                </div>
            `;
            
            // äºˆæƒ³æŠ•ç¨¿å‡¦ç†
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const playerInput = form.querySelector('input[name="predictedPlayer"]:checked');
                const comment = document.getElementById('comment-input').value;
                const photoFile = document.getElementById('photo-upload').files[0];

                if (!playerInput) { return alert('é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); }

                try {
                    form.querySelector('button[type="submit"]').disabled = true;
                    
                    let imageUrl = null;
                    if (photoFile) {
                        const storageRefPath = storageRef(storage, `posts/${userId}/${photoFile.name}_${Date.now()}`);
                        const snapshot = await uploadBytes(storageRefPath, photoFile);
                        imageUrl = await getDownloadURL(snapshot.ref);
                    }

                    await submitPrediction(tournamentId, playerInput.value, comment, imageUrl);
                    alert('äºˆæƒ³ã¨æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                    window.navigate('tournament', { id: tournamentId }); // ç”»é¢ã‚’å†èª­ã¿è¾¼ã¿
                } catch (error) {
                    console.error("Submission Error:", error);
                    alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚äºŒé‡æŠ•ç¥¨ã§ã¯ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } finally {
                    form.querySelector('button[type="submit"]').disabled = false;
                }
            });

            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
            onSnapshot(query(collection(db, postsCol), where('tournamentId', '==', tournamentId)), async (snapshot) => {
                const postsContainer = document.getElementById('timeline');
                let postsHtml = '';

                for (const postDoc of snapshot.docs) {
                    const post = postDoc.data();
                    const postUser = await getProfile(post.userId) || { name: 'ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼', totalPoints: 0 };
                    
                    let predictionText = '';
                    if (post.type === 'prediction') {
                        // äºˆæƒ³é¸æ‰‹åã‚’å–å¾—ï¼ˆPlayersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰æ¢ã™å¿…è¦ã‚ã‚Šã€‚ä»Šå›ã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç›´æ¥æ¢ã™ï¼‰
                        const predictedPlayer = t.players?.find(p => p.id === t.players?.find(pl => pl.id === post.predictedPlayerId)?.id);
                        predictionText = predictedPlayer ? `<p class="font-bold text-indigo-600">ğŸ† ${predictedPlayer.name} ã«å„ªå‹äºˆæƒ³</p>` : '';
                    }

                    postsHtml += `
                        <div class="bg-white p-4 rounded-xl shadow border border-gray-100">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center">
                                    <i data-lucide="user" class="h-6 w-6 mr-2 text-gray-500"></i>
                                    <button onclick="window.navigate('userprofile', { id: '${post.userId}' })" class="font-bold text-gray-800 hover:text-indigo-600">${postUser.name}</button>
                                </div>
                                <p class="text-xs text-gray-400">${post.createdAt?.toDate().toLocaleTimeString() || ''}</p>
                            </div>
                            
                            ${predictionText}
                            
                            ${post.text ? `<p class="text-gray-700 my-2">${post.text}</p>` : ''}
                            
                            ${post.imageUrl ? `<img src="${post.imageUrl}" alt="æŠ•ç¨¿å†™çœŸ" class="w-full max-h-48 object-cover rounded-lg mt-2">` : ''}
                            
                            <div class="flex items-center mt-3 text-sm text-gray-500 border-t pt-2">
                                <i data-lucide="heart" class="h-4 w-4 mr-1"></i> <span>${post.likes || 0}</span>
                            </div>
                        </div>
                    `;
                }
                postsContainer.innerHTML = postsHtml || '<p class="text-center text-gray-500 p-4">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                lucide.createIcons();
            });
        }
        
        /** ã‚¹ãƒãƒ³ã‚µãƒ¼ãƒšãƒ¼ã‚¸ (ã‚¿ã‚¹ã‚¯å®Œäº†) */
        async function renderSponsorPage(container, tournamentId) {
            const tournamentDoc = await getDoc(doc(db, tournamentsCol, tournamentId));
            if (!tournamentDoc.exists()) return;
            const t = tournamentDoc.data();
            const isTaskCompleted = await getTaskCompletion(tournamentId);

            let taskContentHtml = '';
            let isCompleted = isTaskCompleted;

            if (t.taskType === 'quiz_answer') {
                taskContentHtml = `
                    <h3 class="text-xl font-bold mb-3 text-indigo-700">ã‚¯ã‚¤ã‚ºã«å›ç­”ã—ã¦äºˆæƒ³æ¨©ã‚’ã‚¢ãƒ³ãƒ­ãƒƒã‚¯</h3>
                    <p class="mb-4">${t.taskValue}</p>
                    <input type="text" id="quiz-answer" placeholder="å›ç­”ã‚’å…¥åŠ›" class="w-full p-3 border rounded-lg mb-4 focus:ring-indigo-500">
                    <button id="task-complete-btn" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition disabled:bg-gray-400" ${isCompleted ? 'disabled' : ''}>
                        ${isCompleted ? 'ã‚¿ã‚¹ã‚¯å®Œäº†æ¸ˆã¿' : 'å›ç­”ã‚’é€ä¿¡'}
                    </button>
                `;
            } else if (t.taskType === 'video_watch') {
                taskContentHtml = `
                    <h3 class="text-xl font-bold mb-3 text-indigo-700">ãƒ—ãƒ­ãƒ¢å‹•ç”»ã‚’è¦–è´ã—ã¦äºˆæƒ³æ¨©ã‚’ã‚¢ãƒ³ãƒ­ãƒƒã‚¯</h3>
                    <div class="aspect-video bg-gray-300 rounded-lg flex items-center justify-center mb-4">
                        <p class="text-gray-600">å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (${t.taskValue})</p>
                    </div>
                    <button id="task-complete-btn" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition disabled:bg-gray-400" ${isCompleted ? 'disabled' : ''}>
                        ${isCompleted ? 'ã‚¿ã‚¹ã‚¯å®Œäº†æ¸ˆã¿' : 'å‹•ç”»ã‚’æœ€å¾Œã¾ã§è¦–è´'}
                    </button>
                `;
            }


            container.innerHTML = `
                <button onclick="window.navigate('tournament', { id: '${tournamentId}' })" class="text-indigo-600 hover:underline mb-4 flex items-center">
                    <i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i> å¤§ä¼šè©³ç´°ã«æˆ»ã‚‹
                </button>
                
                <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100 space-y-6">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-4">${t.sponsorName} - ã‚¹ãƒãƒ³ã‚µãƒ¼ãƒšãƒ¼ã‚¸</h2>
                    <p class="text-gray-600">ã“ã®å¤§ä¼šã¯${t.sponsorName}æ§˜ã®æä¾›ã§ãŠé€ã‚Šã—ã¦ã„ã¾ã™ã€‚ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã—ã¦ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆã‚’ã‚²ãƒƒãƒˆã—ã¾ã—ã‚‡ã†ã€‚</p>

                    <!-- ã‚¿ã‚¹ã‚¯ã‚¨ãƒªã‚¢ -->
                    <div id="task-area" class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                        ${taskContentHtml}
                    </div>

                    <!-- ã‚¹ãƒãƒ³ã‚µãƒ¼ç´¹ä»‹ -->
                    <div class="pt-4 border-t">
                        <h3 class="text-2xl font-bold mb-3">ä¼æ¥­ç´¹ä»‹</h3>
                        <p class="text-gray-700">æœ€é«˜ã®ã‚´ãƒ«ãƒ•ä½“é¨“ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ã€ç§ãŸã¡ã¯å¸¸ã«é©æ–°çš„ãªè£½å“ã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚ç§ãŸã¡ã®è£½å“ã§ã‚ãªãŸã®ã‚¹ã‚³ã‚¢ã¯å¿…ãšå‘ä¸Šã—ã¾ã™ï¼</p>
                        <img src="https://placehold.co/400x150/000000/FFFFFF?text=${t.sponsorName}+Logo" alt="ã‚¹ãƒãƒ³ã‚µãƒ¼ãƒ­ã‚´" class="w-full rounded-lg mt-3">
                    </div>
                </div>
            `;
            lucide.createIcons();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å†è¨­å®š (DOMæŒ¿å…¥å¾Œ)
            const taskCompleteBtn = document.getElementById('task-complete-btn');
            if (taskCompleteBtn && !isCompleted) {
                if (t.taskType === 'quiz_answer') {
                    taskCompleteBtn.addEventListener('click', async () => {
                        const answerInput = document.getElementById('quiz-answer');
                        const answer = answerInput ? answerInput.value.trim().toLowerCase() : '';
                        
                        // æ—¥æœ¬èªã®ã‚†ã‚‰ãã«å¯¾å¿œ: "ç·‘", "ã¿ã©ã‚Š", "ã‚°ãƒªãƒ¼ãƒ³" ãªã©ã‚’è¨±å®¹
                        const normalizedAnswer = answer.replace(/è‰²/g, '').toLowerCase();
                        const correctAnswers = ['ã¿ã©ã‚Š', 'ç·‘', 'ã‚°ãƒªãƒ¼ãƒ³'];

                        if (correctAnswers.includes(normalizedAnswer)) {
                            await completeTask(tournamentId);
                            alert('æ­£è§£ï¼ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã€ãƒã‚¤ãƒ³ãƒˆ2å€ãƒœãƒ¼ãƒŠã‚¹ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼');
                            window.navigate('tournament', { id: tournamentId });
                        } else {
                            alert('ä¸æ­£è§£ã§ã™ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                        }
                    });
                } else if (t.taskType === 'video_watch') {
                    taskCompleteBtn.addEventListener('click', async () => {
                        // å‹•ç”»è¦–è´ã®å®Œäº†ã¯ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                        await completeTask(tournamentId);
                        alert('è¦–è´å®Œäº†ï¼ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã€ãƒã‚¤ãƒ³ãƒˆ2å€ãƒœãƒ¼ãƒŠã‚¹ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼');
                        window.navigate('tournament', { id: tournamentId });
                    });
                }
            }
        }

        /** ãƒã‚¤ãƒšãƒ¼ã‚¸ (å®Ÿç¸¾ã¨ãƒã‚¤ãƒ³ãƒˆ) */
        async function renderMyPage(container) {
            const profile = await getProfile(userId);
            const q = query(collection(db, predictionsCol), where('userId', '==', userId));
            const snapshot = await getDocs(q);
            const predictions = snapshot.docs.map(doc => doc.data());

            const totalPredictions = predictions.length;
            const correctPredictions = predictions.filter(p => p.isCorrect === true).length;
            const hitRate = totalPredictions > 0 ? ((correctPredictions / totalPredictions) * 100).toFixed(1) : '0.0';

            container.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">ãƒã‚¤ãƒšãƒ¼ã‚¸</h2>
                
                <!-- ã‚µãƒãƒªãƒ¼ -->
                <div class="bg-indigo-600 p-6 rounded-xl text-white shadow-xl mb-6">
                    <p class="text-sm">ã‚ˆã†ã“ãã€</p>
                    <p class="text-3xl font-extrabold mb-4">${profile?.name || '---'}ã•ã‚“</p>
                    <button onclick="window.navigate('store')" class="bg-white text-indigo-600 font-bold py-2 px-4 rounded-full hover:bg-gray-100 transition flex items-center">
                        <i data-lucide="gift" class="w-5 h-5 mr-2"></i> ãƒã‚¤ãƒ³ãƒˆäº¤æ›æ‰€ã¸
                    </button>
                </div>

                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow border text-center">
                        <p class="text-xs text-gray-500">ç´¯è¨ˆãƒã‚¤ãƒ³ãƒˆ</p>
                        <p class="text-2xl font-extrabold text-indigo-700">${profile?.totalPoints?.toLocaleString() || 0}pt</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow border text-center">
                        <p class="text-xs text-gray-500">çš„ä¸­ç‡</p>
                        <p class="text-2xl font-extrabold text-green-600">${hitRate}%</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow border text-center">
                        <p class="text-xs text-gray-500">äºˆæƒ³å›æ•°</p>
                        <p class="text-2xl font-extrabold">${totalPredictions}</p>
                    </div>
                </div>

                <!-- äºˆæƒ³å±¥æ­´ -->
                <h3 class="text-2xl font-bold mb-4 pt-4 border-t">äºˆæƒ³å±¥æ­´ (${totalPredictions}ä»¶)</h3>
                <div id="prediction-history" class="space-y-3">
                    <p class="text-center text-gray-500">ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
                </div>
            `;
            
            // å±¥æ­´ãƒªã‚¹ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            const historyContainer = document.getElementById('prediction-history');
            if (predictions.length === 0) {
                historyContainer.innerHTML = '<p class="text-center text-gray-500 p-8">ã¾ã äºˆæƒ³ã®å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return lucide.createIcons();
            }

            // å±¥æ­´ã«ã¯å¤§ä¼šåãŒå¿…è¦ãªãŸã‚ã€å¤§ä¼šIDã‹ã‚‰åå‰ã‚’å–å¾—
            const tournamentTitles = {};
            for (const t of mockData.tournaments) { tournamentTitles[t.id] = t.title; }

            const historyHtml = predictions.map(p => {
                const statusClass = p.isCorrect === true ? 'bg-green-500' : p.isCorrect === false ? 'bg-red-500' : 'bg-yellow-500';
                const statusText = p.isCorrect === true ? 'çš„ä¸­' : p.isCorrect === false ? 'ãƒã‚ºãƒ¬' : 'çµæœå¾…ã¡';
                const awardedText = p.pointsAwarded > 0 ? `+${p.pointsAwarded}pt` : '';
                const predictedPlayerName = mockData.tournaments.find(t => t.id === p.tournamentId)?.players?.find(pl => pl.id === p.predictedPlayerId)?.name || '---';

                return `
                    <div class="bg-white p-4 rounded-xl shadow border flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-800">${tournamentTitles[p.tournamentId] || 'ä¸æ˜ãªå¤§ä¼š'}</p>
                            <p class="text-sm text-gray-600">äºˆæƒ³: ${predictedPlayerName}</p>
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-3 py-1 text-xs font-bold text-white rounded-full ${statusClass}">${statusText}</span>
                            <p class="text-sm font-semibold text-indigo-600 mt-1">${awardedText}</p>
                        </div>
                    </div>
                `;
            }).join('');
            historyContainer.innerHTML = historyHtml;
            lucide.createIcons();
        }
        
        /** ãƒã‚¤ãƒ³ãƒˆäº¤æ›æ‰€ */
        async function renderRewardStore(container) {
            const profile = await getProfile(userId);
            const currentPoints = profile?.totalPoints || 0;

            container.innerHTML = `
                <button onclick="window.navigate('mypage')" class="text-indigo-600 hover:underline mb-4 flex items-center">
                    <i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i> ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                </button>
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">ãƒã‚¤ãƒ³ãƒˆäº¤æ›æ‰€</h2>
                
                <div class="bg-green-100 p-4 rounded-xl border border-green-300 mb-6 text-center">
                    <p class="text-sm text-green-800">ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆæ®‹é«˜</p>
                    <p class="text-4xl font-extrabold text-green-700">${currentPoints.toLocaleString()}pt</p>
                </div>

                <div id="rewards-list" class="grid grid-cols-2 gap-4">
                    ${mockData.rewards.map(r => {
                        const canAfford = currentPoints >= r.cost;
                        return `
                            <div class="bg-white rounded-xl shadow border overflow-hidden transition hover:shadow-lg flex flex-col">
                                <img src="${r.imageUrl}" alt="${r.name}" class="w-full h-24 object-cover">
                                <div class="p-3 flex flex-col flex-grow">
                                    <p class="font-semibold text-gray-800 flex-grow">${r.name}</p>
                                    <p class="text-lg font-bold text-indigo-600 mt-2">${r.cost.toLocaleString()}pt</p>
                                    <button onclick="window.exchangeReward('${r.id}', ${r.cost})" class="w-full py-2 mt-3 rounded-lg text-white font-bold transition ${canAfford ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-gray-400 cursor-not-allowed'}" ${!canAfford ? 'disabled' : ''}>
                                        ${canAfford ? 'äº¤æ›ã™ã‚‹' : 'ãƒã‚¤ãƒ³ãƒˆä¸è¶³'}
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            lucide.createIcons();
        }

        /** ãƒªãƒ¯ãƒ¼ãƒ‰äº¤æ›ã‚’å®Ÿè¡Œã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•° */
        window.exchangeReward = async (rewardId, cost) => {
            if (!confirm(`æœ¬å½“ã« ${cost}pt ã‚’æ¶ˆè²»ã—ã¦ ${rewardId} ã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            const result = await handleExchangeReward(rewardId, cost);

            if (result.success) {
                alert(result.message);
                window.navigate('store'); // ã‚¹ãƒˆã‚¢ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦æ®‹é«˜ã‚’æ›´æ–°
            } else {
                alert(result.message);
            }
        };

        /** ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ */
        async function renderUserProfilePage(container, targetUserId) {
            const profile = await getProfile(targetUserId);
            if (!profile) {
                container.innerHTML = '<p class="text-red-500">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            const q = query(collection(db, postsCol), where('userId', '==', targetUserId));
            const snapshot = await getDocs(q);
            const posts = snapshot.docs.map(doc => doc.data());

            container.innerHTML = `
                <button onclick="window.navigate('home')" class="text-indigo-600 hover:underline mb-4 flex items-center">
                    <i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i> ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                </button>
                <div class="p-6 bg-white rounded-xl shadow-lg border space-y-6">
                    <div class="flex items-center space-x-4 border-b pb-4">
                        <i data-lucide="user-circle" class="h-12 w-12 text-indigo-500"></i>
                        <div>
                            <h2 class="text-3xl font-extrabold text-gray-900">${profile.name}</h2>
                            <p class="text-sm text-gray-600">ç´¯è¨ˆãƒã‚¤ãƒ³ãƒˆ: ${profile.totalPoints?.toLocaleString() || 0}pt</p>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold mb-3">è‡ªå·±ç´¹ä»‹</h3>
                    <p class="text-gray-700 p-3 bg-gray-50 rounded-lg">${profile.bio || 'è‡ªå·±ç´¹ä»‹æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}</p>

                    <h3 class="text-xl font-bold pt-4 border-t">æŠ•ç¨¿å±¥æ­´ (${posts.length}ä»¶)</h3>
                    <div id="user-posts" class="space-y-4">
                        ${posts.length > 0 ? posts.map(post => `
                            <div class="bg-white p-3 rounded-lg shadow border border-gray-100">
                                <p class="text-xs text-gray-400 mb-1">å¤§ä¼šID: ${post.tournamentId}</p>
                                <p class="text-gray-700">${post.text}</p>
                                ${post.imageUrl ? `<img src="${post.imageUrl}" alt="æŠ•ç¨¿å†™çœŸ" class="w-full max-h-32 object-cover rounded-lg mt-2">` : ''}
                            </div>
                        `).join('') : '<p class="text-center text-gray-500 p-8">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã¾ã æŠ•ç¨¿ã—ã¦ã„ã¾ã›ã‚“ã€‚</p>'}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }


        /** ç®¡ç†ç”»é¢ (çµæœç¢ºå®šã¨ãƒã‚¤ãƒ³ãƒˆä»˜ä¸) */
        async function renderAdminPage(container) {
            container.innerHTML = `
                <h2 class="text-3xl font-extrabold text-red-700 mb-6">âš™ï¸ ç®¡ç†è€…ãƒ“ãƒ¥ãƒ¼</h2>
                <div id="admin-list" class="space-y-4">
                    <p class="text-center text-gray-500">ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
                </div>
            `;
            
            onSnapshot(collection(db, tournamentsCol), (snapshot) => {
                const tournaments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const listHtml = tournaments.map(t => `
                    <div class="bg-white p-4 rounded-xl shadow border">
                        <p class="text-xl font-bold">${t.title} (${t.status})</p>
                        ${t.winnerId ? `<p class="text-green-600 font-semibold mt-1">çµæœç¢ºå®šæ¸ˆã¿: ${t.players?.find(p => p.id === t.winnerId)?.name}</p>` : ''}
                        
                        <form onsubmit="window.handleResultConfirmation(event, '${t.id}', [${t.players?.map(p => `{id:'${p.id}',name:'${p.name}'}`).join(',')}])" class="mt-3 space-y-2">
                            <select name="winnerId" class="w-full p-2 border rounded-lg">
                                <option value="">--- å„ªå‹è€…ã‚’é¸æŠ ---</option>
                                ${t.players?.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                            <button type="submit" class="w-full bg-red-600 text-white font-bold py-2 rounded-lg hover:bg-red-700 transition" ${t.winnerId ? 'disabled' : ''}>
                                ${t.winnerId ? 'çµæœç¢ºå®šæ¸ˆã¿' : 'çµæœã‚’ç¢ºå®šã—ãƒã‚¤ãƒ³ãƒˆä»˜ä¸'}
                            </button>
                        </form>
                    </div>
                `).join('');
                document.getElementById('admin-list').innerHTML = listHtml;
            });
        }

        /** çµæœç¢ºå®šã¨ãƒã‚¤ãƒ³ãƒˆä»˜ä¸å‡¦ç† (ç®¡ç†è€…å°‚ç”¨) */
        window.handleResultConfirmation = async (e, tournamentId, players) => {
            e.preventDefault();
            const winnerId = e.target.elements.winnerId.value;

            if (!winnerId || !confirm(`æœ¬å½“ã« ${players.find(p => p.id === winnerId).name} ã‚’å„ªå‹è€…ã¨ã—ã¦ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ (ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ã•ã‚Œã¾ã™)`)) return;

            try {
                await runTransaction(db, async (transaction) => {
                    const tournamentRef = doc(db, tournamentsCol, tournamentId);
                    
                    // 1. ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆçµæœã®æ›´æ–°
                    transaction.update(tournamentRef, { winnerId: winnerId, status: 'finished' });

                    // 2. äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨æ›´æ–°
                    const predictionsSnapshot = await transaction.get(query(collection(db, predictionsCol), where('tournamentId', '==', tournamentId)));
                    
                    for (const predDoc of predictionsSnapshot.docs) {
                        const prediction = predDoc.data();
                        const isCorrect = prediction.predictedPlayerId === winnerId;
                        let points = 0;
                        
                        // ã‚¿ã‚¹ã‚¯å®Œäº†ãƒœãƒ¼ãƒŠã‚¹ãƒã‚§ãƒƒã‚¯ (ãƒã‚¤ãƒ³ãƒˆ2å€ãƒ­ã‚¸ãƒƒã‚¯)
                        const taskDoc = await getDoc(doc(db, userTasksCol, `${prediction.userId}_${tournamentId}`));
                        const isTaskCompleted = taskDoc.exists() && taskDoc.data().completed;

                        if (isCorrect) {
                            points = isTaskCompleted ? 200 : 100; // 2å€ãƒœãƒ¼ãƒŠã‚¹
                        }

                        // 3. äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã«çµæœã¨ä»˜ä¸ãƒã‚¤ãƒ³ãƒˆã‚’è¨˜éŒ²
                        const predictionRef = doc(db, predictionsCol, predDoc.id);
                        transaction.update(predictionRef, { isCorrect: isCorrect, pointsAwarded: points });

                        // 4. çš„ä¸­è€…ã¸ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ (ãƒã‚¤ãƒ³ãƒˆ > 0 ã®å ´åˆã®ã¿)
                            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ç¢ºå®Ÿã«å–å¾—
                            const profileRef = doc(db, profilesCol, prediction.userId);
                            const profileDoc = await transaction.get(profileRef);

                        if (points > 0 && profileDoc.exists()) {
                                const newPoints = (profileDoc.data().totalPoints || 0) + points;
                                transaction.update(profileRef, { totalPoints: newPoints });
                        }
                    }
                });

                alert('çµæœç¢ºå®šã¨ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                window.navigate('admin'); // ç”»é¢æ›´æ–°
            } catch (error) {
                console.error("Transaction failed:", error);
                alert('å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        };

    </script>
</body>
</html>
